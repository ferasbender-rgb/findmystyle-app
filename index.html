<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kleidungsmarken Erkennung</title>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section, .result-section, .correction-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #imagePreview img {
            max-width: 100%;
            height: auto;
            margin-top: 10px;
        }
        input[type="file"], input[type="text"], button {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        input[type="file"] {
            width: 100%;
        }
        input[type="text"] {
            width: 300px;
        }
        button {
            background-color: #007cba;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #005a87;
        }
        .hidden {
            display: none;
        }
        #dataOutput {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üß• Kleidungsmarken Erkennung</h1>
    
    <div class="upload-section">
        <h3>1. Bild hochladen</h3>
        <input type="file" id="imageUpload" accept="image/*">
        <div id="imagePreview"></div>
    </div>
    
    <div class="result-section">
        <h3>2. Erkennungsergebnis</h3>
        <div id="ocrResult">Warte auf Bild...</div>
        <div id="brandResult"></div>
    </div>
    
    <div id="correctionSection" class="correction-section hidden">
        <h3>3. Korrektur (falls n√∂tig)</h3>
        <p>Korrektur der erkannten Marke:</p>
        <input type="text" id="brandCorrection" placeholder="Richtige Marke eingeben...">
        <button id="submitCorrection">Korrektur speichern</button>
    </div>

    <div id="dataSection" class="result-section hidden">
        <h3>üìä Gesammelte Daten (Kopiere diese in dein Google Sheet)</h3>
        <div id="dataOutput"></div>
        <button onclick="copyToClipboard()">Daten kopieren</button>
        <button onclick="clearData()">Daten l√∂schen</button>
    </div>

    <script>
        // Tesseract.js Worker
        let worker;
        let collectedData = [];

        // Initialisiere Tesseract OCR
        async function initializeOCR() {
            try {
                console.log('Starte Tesseract OCR...');
                worker = await Tesseract.createWorker('eng');
                await worker.loadLanguage('eng');
                await worker.initialize('eng');
                console.log('Tesseract OCR initialisiert');
            } catch (error) {
                console.error('Fehler bei OCR-Initialisierung:', error);
            }
        }

        // Texterkennung durchf√ºhren
        async function recognizeText(imageFile) {
            try {
                if (!worker) {
                    await initializeOCR();
                }
                const { data: { text } } = await worker.recognize(imageFile);
                return text.trim();
            } catch (error) {
                console.error('OCR Fehler:', error);
                return null;
            }
        }

        // Marken aus erkanntem Text extrahieren
        function extractBrands(text) {
            const brands = ['Nike', 'Adidas', 'Puma', 'H&M', 'Zara', 'G-Star', 'Tommy Hilfiger', 'Calvin Klein'];
            const foundBrands = brands.filter(brand => 
                text.toLowerCase().includes(brand.toLowerCase())
            );
            return foundBrands.length > 0 ? foundBrands[0] : 'unbekannt';
        }

        // Training Data sammeln - LOKAL SPEICHERN
        function collectTrainingData(originalData, userCorrection) {
            const trainingData = {
                timestamp: new Date().toISOString(),
                detectedBrand: originalData.detectedBrand,
                correctBrand: userCorrection,
                confidence: originalData.confidence || 0.8,
                fileName: originalData.fileName || 'unknown',
                feedback: originalData.detectedBrand === userCorrection ? 'correct' : 'wrong'
            };
            
            console.log('üìß Speichere Feedback:', trainingData);
            
            // Daten lokal speichern
            collectedData.push(trainingData);
            updateDataDisplay();
            
            // Zeige sofort Erfolgsmeldung
            alert('‚úÖ Feedback erfolgreich gespeichert!');
            
            // UI zur√ºcksetzen
            document.getElementById('correctionSection').style.display = 'none';
            document.getElementById('brandCorrection').value = '';
            
            return true;
        }

        // Daten-Anzeige aktualisieren
        function updateDataDisplay() {
            const output = document.getElementById('dataOutput');
            const dataSection = document.getElementById('dataSection');
            
            if (collectedData.length > 0) {
                dataSection.style.display = 'block';
                
                // Als CSV formatieren (einfach ins Sheet kopieren)
                let csv = 'Timestamp,DetectedBrand,CorrectBrand,Confidence,FileName,FeedbackType\n';
                collectedData.forEach(data => {
                    csv += `"${data.timestamp}","${data.detectedBrand}","${data.correctBrand}",${data.confidence},"${data.fileName}","${data.feedback}"\n`;
                });
                
                output.textContent = csv;
            } else {
                dataSection.style.display = 'none';
            }
        }

        // In Zwischenablage kopieren
        function copyToClipboard() {
            const output = document.getElementById('dataOutput');
            navigator.clipboard.writeText(output.textContent).then(() => {
                alert('‚úÖ Daten kopiert! Jetzt in Google Sheets einf√ºgen.');
            });
        }

        // Daten l√∂schen
        function clearData() {
            collectedData = [];
            updateDataDisplay();
            alert('Daten gel√∂scht');
        }

        // Bild-Upload Event
        document.getElementById('imageUpload').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('imagePreview');
            const resultDiv = document.getElementById('ocrResult');
            const brandResult = document.getElementById('brandResult');
            const correctionSection = document.getElementById('correctionSection');
            const correctionInput = document.getElementById('brandCorrection');

            // Bildvorschau anzeigen
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '300px';
            img.style.border = '1px solid #ccc';
            preview.appendChild(img);

            // OCR durchf√ºhren
            resultDiv.textContent = 'Erkenne Text...';
            brandResult.textContent = 'Analysiere Marke...';

            try {
                const text = await recognizeText(file);
                resultDiv.textContent = text || 'Kein Text erkannt';
                
                const detectedBrand = text ? extractBrands(text) : 'unbekannt';
                brandResult.textContent = `Erkannte Marke: ${detectedBrand}`;
                
                // Korrektur-Sektion anzeigen
                correctionSection.style.display = 'block';
                correctionInput.value = detectedBrand !== 'unbekannt' ? detectedBrand : '';
                correctionInput.focus();
                
                // Aktuelle Daten speichern f√ºr sp√§tere Korrektur
                window.currentOCRData = {
                    detectedBrand: detectedBrand,
                    confidence: text ? 0.8 : 0,
                    fileName: file.name,
                    originalText: text
                };
                
            } catch (error) {
                resultDiv.textContent = 'Fehler bei der Texterkennung';
                brandResult.textContent = 'Markenerkennung fehlgeschlagen';
                console.error('Verarbeitungsfehler:', error);
            }
        });

        // Korrektur abschicken
        function submitCorrection() {
            const correctionInput = document.getElementById('brandCorrection');
            const userBrand = correctionInput.value.trim();
            
            if (!userBrand) {
                alert('Bitte gib eine Marke ein');
                return;
            }
            
            if (!window.currentOCRData) {
                alert('Keine OCR-Daten verf√ºgbar');
                return;
            }
            
            collectTrainingData(window.currentOCRData, userBrand);
        }

        // App initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            initializeOCR();
            
            // Event Listener f√ºr Korrektur-Button
            document.getElementById('submitCorrection').addEventListener('click', submitCorrection);
            
            // Enter-Taste f√ºr Korrektur-Eingabe
            document.getElementById('brandCorrection').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitCorrection();
                }
            });
        });
    </script>
</body>
</html>
