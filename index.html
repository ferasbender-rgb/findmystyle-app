<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kleidungsmarken Erkennung</title>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-section, .result-section, .correction-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        #imagePreview img { max-width: 100%; height: auto; margin-top: 10px; }
        input[type="file"], input[type="text"], button { padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
        .hidden { display: none; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>🧥 Kleidungsmarken Erkennung</h1>
    
    <div class="upload-section">
        <h3>1. Bild hochladen</h3>
        <input type="file" id="imageUpload" accept="image/*">
        <div id="imagePreview"></div>
    </div>
    
    <div class="result-section">
        <h3>2. Erkennungsergebnis</h3>
        <div id="ocrResult">Warte auf Bild...</div>
        <div id="brandResult"></div>
    </div>
    
    <div id="correctionSection" class="correction-section hidden">
        <h3>3. Korrektur (falls nötig)</h3>
        <p>Korrektur der erkannten Marke:</p>
        <input type="text" id="brandCorrection" placeholder="Richtige Marke eingeben...">
        <button id="submitCorrection">Korrektur speichern</button>
    </div>

    <script>
        let worker;

        async function initializeOCR() {
            worker = await Tesseract.createWorker('eng');
            await worker.initialize('eng');
        }

        async function recognizeText(imageFile) {
            if (!worker) await initializeOCR();
            const { data: { text } } = await worker.recognize(imageFile);
            return text.trim();
        }

        function extractBrands(text) {
            const brands = ['Nike', 'Adidas', 'Puma', 'H&M', 'Zara', 'G-Star', 'Tommy Hilfiger', 'Calvin Klein'];
            return brands.find(brand => text.toLowerCase().includes(brand.toLowerCase())) || 'unbekannt';
        }

        // NEU: Daten an unseren eigenen Server senden
        async function saveToSheet(data) {
            try {
                const response = await fetch('https://your-server.onrender.com/save-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('✅ Daten erfolgreich in Google Sheets gespeichert!');
                    return true;
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
            return false;
        }

        document.getElementById('imageUpload').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `<img src="${URL.createObjectURL(file)}" style="max-width: 300px;">`;

            document.getElementById('ocrResult').textContent = 'Erkenne Text...';
            document.getElementById('brandResult').textContent = 'Analysiere Marke...';

            try {
                const text = await recognizeText(file);
                const detectedBrand = text ? extractBrands(text) : 'unbekannt';
                
                document.getElementById('ocrResult').textContent = text || 'Kein Text erkannt';
                document.getElementById('brandResult').textContent = `Erkannte Marke: ${detectedBrand}`;
                
                document.getElementById('correctionSection').style.display = 'block';
                document.getElementById('brandCorrection').value = detectedBrand !== 'unbekannt' ? detectedBrand : '';
                
                window.currentOCRData = {
                    detectedBrand: detectedBrand,
                    fileName: file.name,
                    originalText: text
                };
                
            } catch (error) {
                document.getElementById('ocrResult').textContent = 'Fehler bei der Texterkennung';
            }
        });

        async function submitCorrection() {
            const userBrand = document.getElementById('brandCorrection').value.trim();
            if (!userBrand) return alert('Bitte Marke eingeben');

            const data = {
                timestamp: new Date().toISOString(),
                detectedBrand: window.currentOCRData.detectedBrand,
                correctBrand: userBrand,
                fileName: window.currentOCRData.fileName,
                confidence: 0.8,
                feedback: window.currentOCRData.detectedBrand === userBrand ? 'correct' : 'wrong'
            };

            // Daten an Server senden
            const success = await saveToSheet(data);
            
            if (success) {
                document.getElementById('correctionSection').style.display = 'none';
                document.getElementById('brandCorrection').value = '';
            } else {
                alert('❌ Fehler beim Speichern. Bitte versuche es erneut.');
            }
        }

        document.getElementById('submitCorrection').addEventListener('click', submitCorrection);
        document.getElementById('brandCorrection').addEventListener('keypress', e => {
            if (e.key === 'Enter') submitCorrection();
        });

        initializeOCR();
    </script>
</body>
</html>
